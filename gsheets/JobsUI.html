<!DOCTYPE html>
<html>
  <head>
    <base target="_top" />
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 8px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      th,
      td {
        padding: 6px;
        border-bottom: 1px solid #eee;
        text-align: left;
      }
      button {
        margin-right: 6px;
      }
      .small {
        font-size: 0.85em;
        color: #666;
      }
    </style>
  </head>
  <body>
    <h3>Playback Jobs</h3>
    <div>
      <button id="refresh">Refresh</button>
      <button id="clearDone">Clear Done</button>
      <button id="checkHealthJobs" style="margin-left: 8px">
        Check health
      </button>
      <button id="openProxySettings" style="margin-left: 8px">
        Proxy Settings
      </button>
      <span id="jobsHealth" class="small" style="margin-left: 8px"></span>
    </div>
    <div style="margin-top: 8px">
      <table id="jobsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Status</th>
            <th>Progress</th>
            <th>Device</th>
            <th>Cmds</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div style="margin-top: 10px">
      <strong>Recent Config Audit</strong>
      <div id="auditList" class="small" style="margin-top: 6px"></div>
    </div>
    <script>
      // open proxy settings by showing a prompt (delegates to Timeline's UI or allows inline editing)
      document
        .getElementById("openProxySettings")
        .addEventListener("click", function () {
          // open Timeline sidebar (it contains settings) for convenience
          google.script.run
            .withSuccessHandler(function () {
              // instruct host to open Timeline sidebar
              google.script.host.close();
            })
            .openTimelineSidebar();
        });
      const refreshBtn = document.getElementById("refresh");
      const clearBtn = document.getElementById("clearDone");
      const tbody = document.querySelector("#jobsTable tbody");

      function showToast(msg) {
        google.script.host.close(); // noop to avoid unused warning in some contexts
        console.log(msg);
      }

      function renderJobs(jobs) {
        tbody.innerHTML = "";
        (jobs || []).forEach((j) => {
          const tr = document.createElement("tr");
          const id = document.createElement("td");
          id.textContent = j.enqueue_id || j.enqueueId || "(id)";
          const status = document.createElement("td");
          status.textContent = j.status || "";
          const prog = document.createElement("td");
          prog.textContent =
            j.progress != null ? j.progress + "%" : j.commands_count || 0;
          const dev = document.createElement("td");
          dev.textContent = j.device_id || "";
          const cnt = document.createElement("td");
          cnt.textContent =
            j.commands_count || (j.commands ? j.commands.length : 0);
          const act = document.createElement("td");
          if (
            j.status &&
            (j.status === "queued" ||
              j.status === "running" ||
              j.status === "cancelling")
          ) {
            const cancel = document.createElement("button");
            cancel.textContent = "Cancel";
            cancel.addEventListener("click", () => {
              cancelJob(j.enqueue_id);
            });
            act.appendChild(cancel);
          }
          tr.appendChild(id);
          tr.appendChild(status);
          tr.appendChild(prog);
          tr.appendChild(dev);
          tr.appendChild(cnt);
          tr.appendChild(act);
          tbody.appendChild(tr);
        });
      }

      function refresh() {
        refreshBtn.disabled = true;
        google.script.run
          .withFailureHandler((e) => {
            refreshBtn.disabled = false;
            showToast("Failed: " + e);
          })
          .withSuccessHandler((res) => {
            renderJobs(res);
            refreshBtn.disabled = false;
          })
          .listPlaybackJobs();
      }

      function cancelJob(id) {
        google.script.run
          .withFailureHandler((e) => {
            showToast("Cancel failed: " + e);
          })
          .withSuccessHandler((res) => {
            showToast("Cancel: " + JSON.stringify(res));
            refresh();
          })
          .cancelPlaybackJob(id);
      }

      refreshBtn.addEventListener("click", refresh);
      // load audit entries
      function loadAudit() {
        google.script.run
          .withSuccessHandler(function (rows) {
            const container = document.getElementById("auditList");
            container.innerHTML = "";
            if (!rows || rows.length === 0) {
              container.textContent = "(no audit entries)";
              return;
            }
            rows.forEach(function (r) {
              const d = document.createElement("div");
              const ts = (r.ts && new Date(r.ts).toLocaleString()) || "";
              d.textContent =
                ts + " — " + (r.action || "") + " — " + (r.endpoint || "");
              container.appendChild(d);
            });
          })
          .withFailureHandler(function (e) {
            console.log("audit err", e);
          })
          .getConfigAudit(5);
      }

      loadAudit();
      document
        .getElementById("checkHealthJobs")
        .addEventListener("click", function () {
          const btn = document.getElementById("checkHealthJobs");
          btn.disabled = true;
          google.script.run
            .withSuccessHandler(function (r) {
              try {
                if (r.status === "ok") {
                  document.getElementById("jobsHealth").textContent = "ok";
                  document.getElementById("jobsHealth").style.color = "green";
                } else {
                  document.getElementById("jobsHealth").textContent =
                    r.status || JSON.stringify(r);
                  document.getElementById("jobsHealth").style.color = "orange";
                }
              } catch (e) {
                document.getElementById("jobsHealth").textContent = "err";
                document.getElementById("jobsHealth").style.color = "red";
              }
              btn.disabled = false;
            })
            .withFailureHandler(function (e) {
              document.getElementById("jobsHealth").textContent =
                "health failed";
              document.getElementById("jobsHealth").style.color = "red";
              btn.disabled = false;
            })
            .proxy_checkHealth();
        });
      clearBtn.addEventListener("click", () => {
        /* client-only cleanup: remove rows marked done locally */ tbody
          .querySelectorAll("tr")
          .forEach((r) => {
            const s = r.children[1].textContent;
            if (s === "done" || s === "error" || s === "cancelled") r.remove();
          });
      });

      // initial load
      refresh();
    </script>
  </body>
</html>
