<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>DAWSheet Setup</title>
    <base target="_top" />
    <style>
      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
        padding: 16px;
      }
      label {
        display: block;
        margin-block-start: 10px;
        font-weight: 600;
      }
      input {
        inline-size: 100%;
        padding: 6px 8px;
        margin-block-start: 4px;
        box-sizing: border-box;
      }
      .row {
        margin-block-start: 8px;
      }
      .actions {
        margin-block-start: 16px;
        display: flex;
        gap: 8px;
      }
      button {
        padding: 8px 12px;
      }
      .status {
        margin-block-start: 12px;
        color: #444;
      }
    </style>
  </head>
  <body>
    <h2>DAWSheet Setup Wizard</h2>
    <p>
      Set your Google Cloud project and Pub/Sub topic names, then send a test
      message.
    </p>

    <label for="projectId">GCP Project ID</label>
    <input id="projectId" placeholder="your-project-id" />

    <label for="commandsTopic">Commands Topic</label>
    <input
      id="commandsTopic"
      placeholder="dawsheet.commands"
      value="dawsheet.commands"
    />

    <label for="statusTopic">Status Topic</label>
    <input
      id="statusTopic"
      placeholder="dawsheet.status"
      value="dawsheet.status"
    />

    <div class="actions">
      <button onclick="save()">Save Properties</button>
      <button onclick="testPublish()">Send Test</button>
      <button onclick="pingBridge()">Check Bridge</button>
      <button onclick="listOutputs()">List Outputs</button>
      <button onclick="google.script.host.close()">Close</button>
    </div>
    <div id="status" class="status"></div>

    <script>
      function setStatus(msg, isErr) {
        const el = document.getElementById("status");
        el.textContent = msg;
        el.style.color = isErr ? "#b71c1c" : "#1b5e20";
      }

      function save() {
        const projectId = document.getElementById("projectId").value.trim();
        const commandsTopic = document
          .getElementById("commandsTopic")
          .value.trim();
        const statusTopic = document.getElementById("statusTopic").value.trim();
        setStatus("Saving...", false);
        google.script.run
          .withSuccessHandler(() => {
            setStatus("Saved script properties.", false);
          })
          .withFailureHandler((err) => {
            setStatus("Save failed: " + err.message, true);
          })
          .saveScriptProps({ projectId, commandsTopic, statusTopic });
      }

      function testPublish() {
        setStatus("Sending test message...", false);
        google.script.run
          .withSuccessHandler(() => {
            setStatus("Test message published to commands topic.", false);
          })
          .withFailureHandler((err) => {
            setStatus("Publish failed: " + err.message, true);
          })
          .sendTestPublish();
      }

      function pingBridge() {
        setStatus("Pinging bridge...", false);
        google.script.run
          .withSuccessHandler(() => {
            setStatus("PING sent. Watch status topic for PONG.", false);
          })
          .withFailureHandler((err) => {
            setStatus("Ping failed: " + err.message, true);
          })
          .sendBridgePing();
      }

      function listOutputs() {
        setStatus("Requesting outputs...", false);
        google.script.run
          .withSuccessHandler(() => {
            setStatus("Requested outputs. Watch status topic for list.", false);
          })
          .withFailureHandler((err) => {
            setStatus("Request failed: " + err.message, true);
          })
          .requestOutputsList();
      }

      // Prefill from current Script Properties
      google.script.run
        .withSuccessHandler((props) => {
          if (props.GCP_PROJECT_ID)
            document.getElementById("projectId").value = props.GCP_PROJECT_ID;
          if (props.COMMANDS_TOPIC)
            document.getElementById("commandsTopic").value =
              props.COMMANDS_TOPIC;
          if (props.STATUS_TOPIC)
            document.getElementById("statusTopic").value = props.STATUS_TOPIC;
        })
        .getScriptProps();
    </script>
  </body>
</html>
