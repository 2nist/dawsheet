<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DAWSheet — Trigger Editor</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{ --cream:#f7f3e9; --cream2:#f2ecdf; --ink:#1f2330; --muted:#7a7f8c; --border:#e3dccb; --accent:#2a74ff; --btn:#fbf8f1 }
    body{font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,sans-serif;font-size:11px;margin:6px;background:var(--cream);color:var(--ink)}
    h3{margin:4px 0 6px 0}
    .row{display:flex;gap:6px;margin:4px 0}
    .col{flex:1}
    .col-narrow{max-inline-size:96px;align-self:end}
    .mt6{margin-block-start:6px}
    .mt0{margin-block-start:0}
    .hidden{display:none}
    .pre-scroll{max-block-size:140px;overflow:auto;background:#fff}
    label{display:block;font-size:10px;color:var(--muted);margin-block-end:2px}
    input,select,textarea{inline-size:100%;padding:4px;border:1px solid var(--border);border-radius:8px;background:#fff}
    textarea{min-block-size:54px}
    .btn{padding:4px 6px;border:1px solid var(--border);border-radius:8px;background:var(--btn);cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btnbar{display:flex;gap:6px;margin-block-start:6px}
    .card{border:1px solid var(--border);background:var(--cream2);border-radius:10px;padding:8px;margin-block-end:8px}
    .list{max-block-size:160px;overflow:auto;border:1px solid var(--border);border-radius:8px}
    .item{padding:4px 6px;cursor:pointer}
    .item:hover{background:#fff}
    .muted{color:var(--muted);font-size:10px}
    .error{color:#b00020;font-size:10px;margin-block-start:4px;white-space:pre-wrap}
    .ok{color:#2a7a2a;font-size:10px;margin-block-start:4px;white-space:pre-wrap}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:6px}
  </style>
  <script>
    const EL = sel => document.querySelector(sel);

    async function init(){
      EL('#status').textContent = 'Loading…';
      google.script.run.withSuccessHandler(({triggers, namedRanges, commandTypes})=>{
        window.__named = namedRanges||[];
        EL('#list').innerHTML = (triggers||[]).map(t =>
          `<div class="item" onclick=\"load('${t.id}')\">${t.name} — <span class=\"muted\">${t.type}</span></div>`
        ).join('') || '<div class="item muted">No triggers yet</div>';
        EL('#type').innerHTML = commandTypes.map(t=>`<option value=\"${t}\">${t}</option>`).join('');
        EL('#range').innerHTML = ['', '(type a range like UI!A1:C8)', ...window.__named].map(n=>`<option>${n}</option>`).join('');
        EL('#status').textContent = 'Ready';
      }).te_listEditorBootstrap();
    }

    function load(id){
      google.script.run.withSuccessHandler(t=>{
        if(!t){ alert('Trigger not found'); return; }
        fillForm(t); renderPayloadFields(); showInspectorIfStepGrid(t);
      }).te_getTrigger(id);
    }

    function fillForm(t){
      EL('#id').value = t.id||'';
      EL('#name').value = t.name||'';
      EL('#desc').value = t.description||'';
      EL('#range').value = t.range||'';
      EL('#type').value = t.type||'NOTE.PLAY';
      EL('#target').value = t.target||'default';
      EL('#quantize').value = t.quantize||'off';
      EL('#channel').value = (t.payload && t.payload.channel) || '';
      EL('#payloadJson').value = JSON.stringify(t.payload||{}, null, 2);
      EL('#transforms').value = JSON.stringify(t.transform||[], null, 2);
    }

    function newTrigger(){
      fillForm({ id:'', name:'New Trigger', description:'', range:'', type:'NOTE.PLAY', target:'default', quantize:'off', payload:{ note:'C4', velocity:100, durationSec:0.5, channel:1 }, transform:[] });
      renderPayloadFields();
    }

    function renderPayloadFields(){
      const type = EL('#type').value;
      const p = tryParse(EL('#payloadJson').value) || {};
      const helpers = {
        'NOTE.PLAY': {note: p.note||'C4', velocity: p.velocity||100, durationSec: p.durationSec||0.5, channel: p.channel||Number(EL('#channel').value)||1},
        'CC.SET': {cc: p.cc||74, value: p.value||64, channel: p.channel||Number(EL('#channel').value)||1},
        'CHORD.PLAY': {root: p.root||'C', quality: p.quality||'major', channel: p.channel||Number(EL('#channel').value)||1}
      };
      EL('#payloadJson').value = JSON.stringify(helpers[type] || p, null, 2);
    }

    function tryParse(txt){ try{return JSON.parse(txt)}catch(_){ return null } }

    function preview(){
      const def = gather();
      EL('#previewOut').textContent = 'Compiling…';
      google.script.run.withSuccessHandler(res=>{
        EL('#previewOut').textContent = JSON.stringify(res.envelope, null, 2);
        EL('#previewMsg').className = res.valid ? 'ok' : 'error';
        EL('#previewMsg').textContent = res.valid ? 'Valid command envelope.' : ('Invalid: ' + (res.errors||[]).join('\n'));
      }).withFailureHandler(e=>{
        EL('#previewMsg').className = 'error';
        EL('#previewMsg').textContent = String(e);
      }).te_previewEnvelope(def);
    }

    function save(){
      const def = gather(true);
      google.script.run.withSuccessHandler(({ok,id,error})=>{
        if(!ok) { alert('Save failed: '+error); return; }
        EL('#id').value = id; init();
      }).te_saveTrigger(def);
    }

    function del(){
      const id = EL('#id').value.trim();
      if(!id) return alert('Nothing to delete.');
      if(!confirm('Delete trigger "'+EL('#name').value+'" ?')) return;
      google.script.run.withSuccessHandler(()=>{ newTrigger(); init(); }).te_deleteTrigger(id);
    }

    function gather(strict){
      const payload = tryParse(EL('#payloadJson').value) || {};
      const transform = tryParse(EL('#transforms').value) || [];
      const def = {
        id: EL('#id').value.trim(),
        name: EL('#name').value.trim(),
        description: EL('#desc').value.trim(),
        range: EL('#range').value.trim(),
        type: EL('#type').value,
        target: EL('#target').value.trim() || 'default',
        quantize: EL('#quantize').value || 'off',
        payload, transform
      };
      if(strict){ if(!def.name) throw new Error('Name is required'); if(!def.range) throw new Error('Range or Named range is required'); }
      return def;
    }

    function showInspectorIfStepGrid(t){
      const bh = t.behavior || {}; const isSG = (bh.kind === 'grid-steps');
      document.getElementById('inspectorStepGrid').style.display = isSG ? 'block' : 'none';
      if (!isSG) return;
      google.script.run.withSuccessHandler(d=>{
        document.getElementById('sg_channel').value = d.channel || 10;
        document.getElementById('sg_baseNote').value = d.baseNote || '36';
        document.getElementById('sg_resolution').value = d.resolution || '1/16';
        document.getElementById('sg_duration').value = d.durationBeats || 0.9;
        document.getElementById('sg_velDefault').value = d.velocityDefault || 100;
        document.getElementById('sg_bypass').value = String(!!d.bypass);
        document.getElementById('inspectorMsg').textContent = 'Inspector ready.';
      }).te_getStepGridInspectorData(t.id);
    }

    function inspectorLoad(){
      const id = document.getElementById('id').value; if (!id) return;
      google.script.run.withSuccessHandler(d=>{
        document.getElementById('sg_channel').value = d.channel || 10;
        document.getElementById('sg_baseNote').value = d.baseNote || '36';
        document.getElementById('sg_resolution').value = d.resolution || '1/16';
        document.getElementById('sg_duration').value = d.durationBeats || 0.9;
        document.getElementById('sg_velDefault').value = d.velocityDefault || 100;
        document.getElementById('sg_bypass').value = String(!!d.bypass);
        document.getElementById('inspectorMsg').textContent = 'Reloaded.';
      }).te_getStepGridInspectorData(id);
    }

    function inspectorSave(){
      const id = document.getElementById('id').value; if (!id) return alert('Save the trigger first.');
      const body = {
        channel: Number(document.getElementById('sg_channel').value) || 10,
        baseNote: document.getElementById('sg_baseNote').value || '36',
        resolution: document.getElementById('sg_resolution').value || '1/16',
        durationBeats: Number(document.getElementById('sg_duration').value) || 0.9,
        velocityDefault: Number(document.getElementById('sg_velDefault').value) || 100,
        bypass: document.getElementById('sg_bypass').value === 'true'
      };
      google.script.run.withSuccessHandler(msg=>{ document.getElementById('inspectorMsg').textContent = msg || 'Saved.'; })
        .withFailureHandler(e=>{ document.getElementById('inspectorMsg').textContent = String(e); })
        .te_updateStepGridInspector(id, body);
    }
  </script>
</head>
<body onload="init()">
  <h3>Trigger Editor</h3>

  <div class="card">
    <div class="row">
      <div class="col"><label>Triggers</label>
        <div id="list" class="list"></div>
      </div>
      <div class="col col-narrow">
        <button class="btn" onclick="newTrigger()">New</button>
      </div>
    </div>
    <div class="muted" id="status">Ready</div>
  </div>

  <div class="card">
    <div class="grid2">
      <div>
        <label for="name">Name</label><input id="name" placeholder="e.g., STEP_GRID_1" title="Trigger name">
      </div>
      <div>
        <label for="range">Range / Named Range</label>
        <select id="range" title="Choose a named range or enter A1-style"></select>
      </div>
      <div>
        <label for="type">Command Type</label>
        <select id="type" title="Command type" onchange="renderPayloadFields()"></select>
      </div>
      <div>
        <label for="target">Target</label><input id="target" placeholder="default" title="Target device or channel tag">
      </div>
      <div>
        <label for="quantize">Quantize</label>
        <select id="quantize" title="Quantization grid">
          <option>off</option><option>1/4</option><option>1/8</option><option>1/8T</option><option>1/16</option><option>bar</option><option>scene</option>
        </select>
      </div>
      <div>
        <label for="channel">Channel (helper)</label><input id="channel" type="number" min="1" max="16" value="1" title="MIDI channel" oninput="renderPayloadFields()">
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="desc">Description</label>
        <textarea id="desc" placeholder="What this control does…" title="Describe the trigger"></textarea>
      </div>
    </div>

    <div class="row">
      <div class="col">
        <label for="payloadJson">Payload (JSON)</label>
        <textarea id="payloadJson" title="Command payload JSON">{}</textarea>
      </div>
      <div class="col">
        <label for="transforms">Transforms (JSON array)</label>
        <textarea id="transforms" title="Transforms JSON array">[]</textarea>
      </div>
    </div>

    <div class="btnbar">
      <button class="btn" onclick="preview()">Preview</button>
      <button class="btn primary" onclick="save()">Save</button>
      <button class="btn" onclick="del()">Delete</button>
    </div>

    <div id="previewMsg" class="muted mt6"></div>
    <pre id="previewOut" class="card pre-scroll"></pre>
    <input id="id" type="hidden">
  </div>

  <div id="inspectorStepGrid" class="card hidden">
    <h3 class="mt0">Step Grid Inspector</h3>
    <div class="grid2">
      <div>
        <label>Channel</label>
        <input id="sg_channel" type="number" min="1" max="16">
      </div>
      <div>
        <label>Base Note (MIDI # or name)</label>
        <input id="sg_baseNote" placeholder="36 or C1">
      </div>
      <div>
        <label>Resolution</label>
        <select id="sg_resolution">
          <option>1/4</option><option>1/8</option><option>1/8T</option><option>1/16</option><option>bar</option><option>scene</option>
        </select>
      </div>
      <div>
        <label>Duration (beats)</label>
        <input id="sg_duration" type="number" step="0.05" min="0" value="0.9">
      </div>
      <div>
        <label>Velocity Default</label>
        <input id="sg_velDefault" type="number" min="0" max="127" value="100">
      </div>
      <div>
        <label>Bypass</label>
        <select id="sg_bypass"><option value="false">OFF</option><option value="true">ON</option></select>
      </div>
    </div>
    <div class="btnbar">
      <button class="btn" onclick="inspectorLoad()">Reload</button>
      <button class="btn primary" onclick="inspectorSave()">Save Inspector</button>
    </div>
    <div id="inspectorMsg" class="muted mt6"></div>
  </div>

  <div class="muted">Tip: Prefer <b>Named ranges</b> for controls; avoid color/border triggers.</div>
</body>
</html>
